{% extends 'admin/base.html.twig' %}
{% block title %}Webinaires{% endblock %}
{% block body %}
<div class="admin-content">
    <div class="page-header">
        <h1>Webinaires</h1>
        <a href="{{ path('admin_webinar_new') }}" class="btn btn-primary"><i class="fas fa-plus"></i> Nouveau webinaire</a>
    </div>
    <div class="table-container">
        <table class="admin-table">
            <thead>
                <tr><th>Nom</th><th>Date</th><th>Durée</th><th>Statut</th><th>Actions</th></tr>
            </thead>
            <tbody>
                {% for webinar in webinars %}
                <tr>
                    <td>{{ webinar.name }}</td>
                    <td>{{ webinar.date|date('d/m/Y H:i') }}</td>
                    <td>{{ webinar.duration ?? '-' }} min</td>
                    <td>
                        {% if webinar.isActive %}<span class="badge badge-success">Actif</span>
                        {% else %}<span class="badge badge-secondary">Inactif</span>{% endif %}
                    </td>
                    <td class="actions">
                        <button type="button" class="btn btn-sm btn-info" 
                                onclick="openEmailModal({{ webinar.id }}, '{{ webinar.name|e('js') }}')"
                                data-csrf="{{ csrf_token('send_email' ~ webinar.id) }}"
                                data-webinar-id="{{ webinar.id }}"
                                title="Envoyer un email">
                            <i class="fas fa-envelope"></i>
                        </button>
                        <a href="{{ path('admin_webinar_edit', {id: webinar.id}) }}" class="btn btn-sm btn-primary"><i class="fas fa-edit"></i></a>
                        <form method="post" action="{{ path('admin_webinar_delete', {id: webinar.id}) }}" style="display:inline;">
                            <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ webinar.id) }}">
                            <button class="btn btn-sm btn-danger" onclick="return confirm('Supprimer?')"><i class="fas fa-trash"></i></button>
                        </form>
                    </td>
                </tr>
                {% else %}<tr><td colspan="5" style="text-align:center;">Aucun webinaire</td></tr>{% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Modal pour l'envoi d'email -->
<div id="emailModal" class="modal" style="display: none;">
    <div class="modal-backdrop" onclick="closeEmailModal()"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-envelope"></i> Envoyer notification webinaire</h3>
            <button type="button" class="modal-close" onclick="closeEmailModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="emailForm">
                <input type="hidden" id="webinarId" name="webinar_id" value="">
                <input type="hidden" id="csrfToken" name="_token" value="">
                
                <div class="form-group">
                    <label class="form-label">Destinataires :</label>
                    
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="send_to" value="all" checked onchange="togglePersonsList()">
                            <span class="radio-label">
                                <i class="fas fa-users"></i> Tous les abonnés newsletter
                                <small>({{ subscribers|length }} personne{% if subscribers|length > 1 %}s{% endif %})</small>
                            </span>
                        </label>
                        
                        <label class="radio-option">
                            <input type="radio" name="send_to" value="selected" onchange="togglePersonsList()">
                            <span class="radio-label">
                                <i class="fas fa-user-check"></i> Sélectionner des personnes
                            </span>
                        </label>
                    </div>
                </div>
                
                <div id="personsList" class="form-group" style="display: none;">
                    <label class="form-label">Sélectionner les destinataires :</label>
                    <div class="search-box">
                        <input type="text" id="searchPersons" placeholder="Rechercher..." onkeyup="filterPersons()">
                    </div>
                    <div class="checkbox-list" id="personsCheckboxList">
                        {% for person in allPersons %}
                        <label class="checkbox-option" data-search="{{ person.firstName|lower }} {{ person.lastName|lower }} {{ person.email|lower }}">
                            <input type="checkbox" name="persons[]" value="{{ person.id }}">
                            <span class="checkbox-label">
                                {{ person.firstName }} {{ person.lastName }}
                                <small>{{ person.email }}</small>
                                {% if person.subscribedToNewsletter %}
                                <span class="badge badge-success badge-sm">Abonné</span>
                                {% endif %}
                            </span>
                        </label>
                        {% endfor %}
                    </div>
                    <div class="selection-actions">
                        <button type="button" class="btn btn-sm btn-secondary" onclick="selectAllVisible()">Tout sélectionner</button>
                        <button type="button" class="btn btn-sm btn-secondary" onclick="deselectAll()">Tout désélectionner</button>
                        <button type="button" class="btn btn-sm btn-secondary" onclick="selectSubscribers()">Sélectionner abonnés</button>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeEmailModal()">Annuler</button>
            <button type="button" class="btn btn-primary" onclick="sendEmails()" id="sendBtn">
                <i class="fas fa-paper-plane"></i> Envoyer
            </button>
        </div>
    </div>
</div>

<style>
.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
}
.modal-backdrop {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
}
.modal-content {
    position: relative;
    background: #fff;
    border-radius: 8px;
    width: 90%;
    max-width: 600px;
    max-height: 80vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
}
.modal-header {
    padding: 15px 20px;
    background: #7A8F6E;
    color: #fff;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.modal-header h3 {
    margin: 0;
    font-size: 1.2em;
}
.modal-close {
    background: none;
    border: none;
    color: #fff;
    font-size: 1.5em;
    cursor: pointer;
    padding: 0;
    line-height: 1;
}
.modal-body {
    padding: 20px;
    overflow-y: auto;
    flex: 1;
}
.modal-footer {
    padding: 15px 20px;
    background: #f5f5f5;
    display: flex;
    justify-content: flex-end;
    gap: 10px;
}
.form-group {
    margin-bottom: 20px;
}
.form-label {
    display: block;
    font-weight: 600;
    margin-bottom: 10px;
    color: #333;
}
.radio-group {
    display: flex;
    flex-direction: column;
    gap: 10px;
}
.radio-option {
    display: flex;
    align-items: flex-start;
    cursor: pointer;
    padding: 12px 15px;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    transition: all 0.2s;
}
.radio-option:hover {
    border-color: #7A8F6E;
    background: #f9f9f9;
}
.radio-option input[type="radio"] {
    margin-right: 12px;
    margin-top: 3px;
}
.radio-option input[type="radio"]:checked + .radio-label {
    color: #7A8F6E;
}
.radio-label {
    display: flex;
    flex-direction: column;
    gap: 2px;
}
.radio-label i {
    margin-right: 8px;
}
.radio-label small {
    color: #666;
    font-size: 0.85em;
}
.search-box {
    margin-bottom: 10px;
}
.search-box input {
    width: 100%;
    padding: 10px 15px;
    border: 1px solid #ddd;
    border-radius: 5px;
    font-size: 0.95em;
}
.checkbox-list {
    max-height: 250px;
    overflow-y: auto;
    border: 1px solid #e0e0e0;
    border-radius: 5px;
    margin-bottom: 10px;
}
.checkbox-option {
    display: flex;
    align-items: center;
    padding: 10px 15px;
    cursor: pointer;
    border-bottom: 1px solid #f0f0f0;
    transition: background 0.2s;
}
.checkbox-option:last-child {
    border-bottom: none;
}
.checkbox-option:hover {
    background: #f9f9f9;
}
.checkbox-option input[type="checkbox"] {
    margin-right: 12px;
}
.checkbox-label {
    display: flex;
    flex-direction: column;
    gap: 2px;
    flex: 1;
}
.checkbox-label small {
    color: #666;
    font-size: 0.85em;
}
.badge-sm {
    font-size: 0.7em;
    padding: 2px 6px;
}
.selection-actions {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}
.btn-info {
    background: #17a2b8;
    border-color: #17a2b8;
    color: #fff;
}
.btn-info:hover {
    background: #138496;
    border-color: #117a8b;
}
</style>

<script>
let currentWebinarId = null;
let currentCsrfToken = null;

function openEmailModal(webinarId, webinarName) {
    currentWebinarId = webinarId;
    // Récupérer le token CSRF depuis le data-attribute du bouton
    const btn = document.querySelector(`button[data-webinar-id="${webinarId}"]`);
    currentCsrfToken = btn.dataset.csrf;
    
    document.getElementById('webinarId').value = webinarId;
    document.getElementById('csrfToken').value = currentCsrfToken;
    document.getElementById('emailModal').style.display = 'flex';
    document.body.style.overflow = 'hidden';
    
    // Reset form
    document.querySelector('input[name="send_to"][value="all"]').checked = true;
    togglePersonsList();
    deselectAll();
}

function closeEmailModal() {
    document.getElementById('emailModal').style.display = 'none';
    document.body.style.overflow = '';
    currentWebinarId = null;
}

function togglePersonsList() {
    const sendTo = document.querySelector('input[name="send_to"]:checked').value;
    document.getElementById('personsList').style.display = sendTo === 'selected' ? 'block' : 'none';
}

function filterPersons() {
    const search = document.getElementById('searchPersons').value.toLowerCase();
    const options = document.querySelectorAll('.checkbox-option');
    
    options.forEach(option => {
        const searchText = option.dataset.search;
        option.style.display = searchText.includes(search) ? 'flex' : 'none';
    });
}

function selectAllVisible() {
    const options = document.querySelectorAll('.checkbox-option');
    options.forEach(option => {
        if (option.style.display !== 'none') {
            option.querySelector('input[type="checkbox"]').checked = true;
        }
    });
}

function deselectAll() {
    const checkboxes = document.querySelectorAll('#personsCheckboxList input[type="checkbox"]');
    checkboxes.forEach(cb => cb.checked = false);
}

function selectSubscribers() {
    const options = document.querySelectorAll('.checkbox-option');
    options.forEach(option => {
        const hasSubscriberBadge = option.querySelector('.badge-success') !== null;
        option.querySelector('input[type="checkbox"]').checked = hasSubscriberBadge;
    });
}

async function sendEmails() {
    const btn = document.getElementById('sendBtn');
    const originalText = btn.innerHTML;
    
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Envoi en cours...';
    
    const formData = new FormData(document.getElementById('emailForm'));
    formData.set('_token', currentCsrfToken);
    
    try {
        const response = await fetch(`/admin/webinars/${currentWebinarId}/send-email`, {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('✅ ' + result.message);
            closeEmailModal();
        } else {
            alert('❌ Erreur : ' + result.message);
        }
    } catch (error) {
        alert('❌ Erreur lors de l\'envoi : ' + error.message);
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
}

// Close modal on escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && document.getElementById('emailModal').style.display === 'flex') {
        closeEmailModal();
    }
});
</script>
{% endblock %}
